<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ˜¥ç¯€å¿ƒæƒ…å°é…’é¤¨</title>
    
    <!-- æ¨£å¼åº« -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- å­—å‹ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- å…¨åŸŸæ¨£å¼ -->
    <style>
      body { font-family: 'Zen Maru Gothic', sans-serif; }
      h1, h2, h3, .serif { font-family: 'Noto Serif TC', serif; }
      .glass-panel {
        background: rgba(40, 10, 10, 0.6);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 215, 0, 0.2);
      }
      textarea::-webkit-scrollbar { width: 8px; }
      textarea::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
      textarea::-webkit-scrollbar-thumb { background: rgba(255, 215, 0, 0.3); border-radius: 4px; }
      @keyframes float {
        0% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
        100% { transform: translateY(0px); }
      }
      .animate-float { animation: float 6s ease-in-out infinite; }
    </style>

    <!-- Import Map -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "@google/genai": "https://esm.sh/@google/genai@0.2.1"
      }
    }
    </script>
    
    <!-- Babel Standalone -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-black text-white">
    
    <!-- å®‰å…¨æ€§æª¢æŸ¥è…³æœ¬ -->
    <script>
      if (window.location.protocol === 'file:') {
         document.body.innerHTML = `
           <div style="display:flex;height:100vh;align-items:center;justify-content:center;background:linear-gradient(to bottom right, #1a0505, #000);color:#fcd34d;font-family:sans-serif;flex-direction:column;text-align:center;padding:20px;">
             <h1 style="font-size:3rem;margin-bottom:20px;">âš ï¸ ç„¡æ³•ç›´æ¥é–‹å•Ÿ</h1>
             <p style="color:#fca5a5;font-size:1.2rem;max-width:600px;line-height:1.6;">
               è«‹å°‡æ­¤æª”æ¡ˆä¸Šå‚³è‡³ GitHub Pages å³å¯æ­£å¸¸ä½¿ç”¨ã€‚
             </p>
           </div>
         `;
         throw new Error("Blocked by file protocol safety check");
      }
    </script>

    <div id="root"></div>

    <!-- ä¸»ç¨‹å¼é‚è¼¯ -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, forwardRef, useImperativeHandle } from 'react';
        import ReactDOM from 'react-dom/client';
        import { GoogleGenAI } from "@google/genai";

        // --- æœå‹™å±¤ (Service) ---
        
        // ==========================================
        // â–¼â–¼â–¼ è«‹åœ¨ä¸‹æ–¹å¡«å…¥æ‚¨çš„ API KEY (é‡è¦) â–¼â–¼â–¼
        // ==========================================
        
        // è«‹å°‡æ‚¨çš„ Key å¡«å…¥ä¸‹æ–¹çš„é›™å¼•è™Ÿä¸­ã€‚
        // ä¾‹å¦‚: const HARDCODED_KEY = "AIzaSyDxxxxxxxx...";
        
        const HARDCODED_KEY = " "; 

        // ==========================================
        // â–²â–²â–² å¡«å¯«å®Œç•¢å¾Œï¼Œè«‹ä¸Šå‚³æ­¤æª”æ¡ˆåˆ° GitHub â–²â–²â–²
        // ==========================================

        const SYSTEM_INSTRUCTION = `
        ä½ æ˜¯ã€Œæ˜¥ç¯€å¿ƒæƒ…å°é…’é¤¨ã€çš„ AI èª¿é…’å¸«ã€‚
        ä½ çš„ä»»å‹™æ˜¯æ ¹æ“šå®¢äººçš„å¿ƒæƒ…ï¼Œè¨­è¨ˆä¸€æ¬¾ã€Œç‰¹èª¿é£²å“ (Mocktail/Creative Drink)ã€ï¼Œä¸¦å¯«ä¸‹ä¸€æ®µæº«æš–çš„è©±ã€‚
        ã€æŒ‡ä»¤ã€‘
        1. è«‹å›å‚³ç´” JSON æ ¼å¼ã€‚
        2. ä¸è¦ä½¿ç”¨ Markdown ä»£ç¢¼å€å¡Šã€‚
        3. é£²å“è¨­è¨ˆè«‹å……æ»¿å‰µæ„èˆ‡ç¾æ„Ÿã€‚
        JSON æ ¼å¼ç¯„ä¾‹ï¼š
        {
          "name": "é£²å“åç¨±",
          "description": "50å­—ä»¥å…§çš„å£æ„Ÿèˆ‡å¤–è§€æè¿°",
          "ingredients": ["ææ–™1", "ææ–™2"],
          "quote": "80å­—ä»¥å…§çš„æš–å¿ƒå°èª",
          "visualPrompt": "Photorealistic beverage photography, cinematic lighting, [æè¿°é£²å“], 8k resolution"
        }
        `;

        const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        async function retryOperation(operation, retries = 3, baseWait = 2000) {
            let lastError;
            for (let attempt = 0; attempt < retries; attempt++) {
                try {
                    return await operation();
                } catch (error) {
                    lastError = error;
                    const msg = error.message || '';
                    if (msg.includes('429') || msg.includes('quota')) {
                        const waitTime = baseWait * Math.pow(2, attempt);
                        console.warn(`API Busy. Retrying in ${waitTime}ms...`);
                        await delay(waitTime);
                        continue;
                    }
                    throw error;
                }
            }
            throw lastError;
        }

        const generateCocktailRecipe = async (apiKey, userMood) => {
            const ai = new GoogleGenAI({ apiKey: apiKey });
            return retryOperation(async () => {
                const response = await ai.models.generateContent({
                    model: "gemini-3-flash-preview",
                    contents: `å®¢äººçš„å¿ƒæƒ…æ˜¯ï¼š${userMood}`,
                    config: { systemInstruction: SYSTEM_INSTRUCTION, responseMimeType: "application/json" }
                });
                
                let cleanText = response.text.replace(/```json/g, '').replace(/```/g, '');
                const jsonMatch = cleanText.match(/\{[\s\S]*\}/);
                if (jsonMatch) cleanText = jsonMatch[0];
                return JSON.parse(cleanText);
            }, 3, 2000);
        };

        const generateCocktailImage = async (apiKey, visualPrompt) => {
            const ai = new GoogleGenAI({ apiKey: apiKey });
            try {
                return await retryOperation(async () => {
                    const response = await ai.models.generateContent({
                        model: "gemini-2.5-flash-image",
                        contents: { parts: [{ text: `${visualPrompt}, non-alcoholic, artistic beverage photography, cozy atmosphere` }] },
                        config: { imageConfig: { aspectRatio: "1:1" } }
                    });
                    
                    for (const part of response.candidates[0].content.parts) {
                        if (part.inlineData) return `data:image/png;base64,${part.inlineData.data}`;
                    }
                    throw new Error("No image");
                }, 2, 4000);
            } catch (e) {
                console.warn("Image gen failed", e);
                return "FALLBACK";
            }
        };

        // --- å…ƒä»¶ (Components) ---

        const AudioPlayer = forwardRef((props, ref) => {
            const [isPlaying, setIsPlaying] = useState(false);
            const audioRef = useRef(null);
            
            useImperativeHandle(ref, () => ({
                playMusic: () => {
                    if(audioRef.current) audioRef.current.play().then(() => setIsPlaying(true)).catch(e=>console.warn(e));
                }
            }));

            const toggle = () => {
                if (isPlaying) audioRef.current.pause();
                else audioRef.current.play();
                setIsPlaying(!isPlaying);
            };

            useEffect(() => { if(audioRef.current) audioRef.current.volume = 0.5; }, []);

            return (
                <div className="fixed top-4 right-4 z-50">
                    <audio ref={audioRef} src="https://cdn.pixabay.com/audio/2022/11/22/audio_febc508520.mp3" loop />
                    <button onClick={toggle} className="glass-panel text-amber-400 p-3 rounded-full hover:bg-red-900/50 transition-all border border-amber-400/30">
                        {isPlaying ? (
                          <div className="flex space-x-1 items-end h-4 w-4 justify-center">
                             <div className="w-1 h-2 bg-amber-400 animate-pulse"></div>
                             <div className="w-1 h-4 bg-amber-400 animate-pulse delay-75"></div>
                             <div className="w-1 h-3 bg-amber-400 animate-pulse delay-150"></div>
                          </div>
                        ) : "ğŸ”‡"}
                    </button>
                </div>
            );
        });

        const LoadingScreen = ({ status }) => (
            <div className="flex flex-col items-center justify-center min-h-[300px] text-amber-100 space-y-8 animate-pulse">
                <div className="text-6xl animate-bounce text-amber-400 opacity-80">{status === 'analyzing' ? 'ğŸ¥‚' : 'ğŸ¸'}</div>
                <div className="text-center space-y-2">
                    <h3 className="text-2xl font-serif text-amber-300">{status === 'analyzing' ? 'æ­£åœ¨ç´°è®€æ‚¨çš„å¿ƒäº‹...' : 'æ­£åœ¨ç‚ºæ‚¨èª¿è£½å°ˆå±¬ç‰¹èª¿...'}</h3>
                    <p className="text-red-200/60 font-light text-sm">{status === 'analyzing' ? 'é…’ä¿æ­£åœ¨æ€è€ƒæœ€é©åˆæ‚¨çš„é¢¨å‘³' : 'åŠ å…¥ä¸€é»æ˜¥ç¯€çš„å–œæ°£èˆ‡å¸Œæœ›'}</p>
                </div>
            </div>
        );

        const ResultCard = ({ recipe, imageUrl, onReset }) => {
            const isFallback = imageUrl === "FALLBACK";
            return (
                <div className="w-full max-w-4xl mx-auto animate-float">
                    <div className="glass-panel rounded-2xl overflow-hidden shadow-2xl shadow-red-900/50 flex flex-col md:flex-row">
                        <div className="w-full md:w-1/2 relative min-h-[300px] md:min-h-[500px] bg-black">
                            {isFallback ? (
                                <div className="absolute inset-0 flex items-center justify-center text-6xl">ğŸ·</div>
                            ) : (
                                <img src={imageUrl} alt={recipe.name} className="absolute inset-0 w-full h-full object-cover" />
                            )}
                            <div className="absolute inset-0 bg-gradient-to-t from-red-950/90 to-transparent md:bg-gradient-to-r" />
                        </div>
                        <div className="w-full md:w-1/2 p-8 md:p-12 flex flex-col justify-center text-left space-y-6 relative">
                            <div className="absolute top-4 right-4 text-amber-500/20 text-6xl font-serif pointer-events-none">ç¦</div>
                            <h2 className="text-4xl md:text-5xl font-serif text-amber-400 leading-tight">{recipe.name}</h2>
                            <p className="text-red-100/80 italic border-l-2 border-amber-600/50 pl-4">{recipe.description}</p>
                            <div className="space-y-2">
                                <h4 className="text-amber-500 text-sm font-bold uppercase">é…æ–¹ Ingredients</h4>
                                <ul className="flex flex-wrap gap-2">
                                    {recipe.ingredients.map((ing, idx) => <li key={idx} className="text-xs bg-red-900/40 text-red-200 px-3 py-1 rounded-full border border-red-700/30">{ing}</li>)}
                                </ul>
                            </div>
                            <div className="bg-red-950/40 p-6 rounded-xl border border-amber-500/10 mt-4 relative">
                                <p className="text-amber-100/90 font-serif text-lg leading-loose relative z-10 text-justify">â€œ {recipe.quote} â€</p>
                            </div>
                            <button onClick={onReset} className="px-8 py-3 bg-gradient-to-r from-amber-700 to-amber-600 text-amber-100 rounded-full hover:from-amber-600 hover:to-amber-500 transition-all shadow-lg font-bold">å†ä¾†ä¸€æ¯</button>
                        </div>
                    </div>
                </div>
            );
        };

        const KeyInputModal = ({ onSave }) => {
            const [input, setInput] = useState('');
            
            const handleConfirm = () => {
                if (input.length > 5) {
                    onSave(input);
                }
            };

            return (
                <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
                    <div className="glass-panel p-8 rounded-2xl max-w-md w-full text-center space-y-6 border border-amber-500/30">
                        <h3 className="text-2xl font-serif text-amber-400">è«‹å‡ºç¤ºæ‚¨çš„é€šè¡Œè­‰</h3>
                        <p className="text-red-200/70 text-sm">æ­¤é…’é¤¨éœ€è¦ Gemini API Key æ‰èƒ½é‹ä½œã€‚</p>
                        <input 
                            type="password" 
                            value={input}
                            onChange={(e) => setInput(e.target.value)}
                            placeholder="è²¼ä¸Šæ‚¨çš„ API Key (AIzaSy...)"
                            className="w-full bg-black/40 border border-amber-900/50 rounded-lg p-3 text-amber-100 focus:outline-none focus:border-amber-500"
                        />
                        <button 
                            onClick={handleConfirm}
                            disabled={input.length < 10}
                            className="w-full py-3 bg-gradient-to-r from-red-900 to-red-800 text-amber-100 rounded-lg hover:brightness-110 disabled:opacity-50"
                        >
                            é€²å…¥é…’é¤¨ Enter
                        </button>
                        <p className="text-xs text-gray-500 mt-4">
                            è¼¸å…¥å¾Œç³»çµ±å°‡è‡ªå‹•è¨˜æ†¶ (LocalStorage)ï¼Œä¸‹æ¬¡ç„¡éœ€å†æ¬¡è¼¸å…¥ã€‚<br/>
                            Key åƒ…å„²å­˜åœ¨æ‚¨çš„ç€è¦½å™¨ç«¯ï¼Œçµ•ä¸ä¸Šå‚³ã€‚
                        </p>
                    </div>
                </div>
            );
        };

        // --- ä¸»ç¨‹å¼ (App) ---

        function App() {
            // å„ªå…ˆä½¿ç”¨ Hardcoded Key -> å…¶æ¬¡æª¢æŸ¥ LocalStorage -> æœ€å¾Œç‚ºç©º (è§¸ç™¼ Modal)
            const [userKey, setUserKey] = useState(() => {
                if (HARDCODED_KEY) return HARDCODED_KEY;
                return localStorage.getItem('gemini_api_key') || "";
            });

            const [mood, setMood] = useState('');
            const [status, setStatus] = useState('idle'); // idle, analyzing, mixing, served, error
            const [recipe, setRecipe] = useState(null);
            const [imageUrl, setImageUrl] = useState(null);
            const [errorMsg, setErrorMsg] = useState('');
            const audioPlayerRef = useRef(null);

            // æ›´æ–° Key ä¸¦å¯«å…¥ LocalStorage
            const handleSetKey = (key) => {
                localStorage.setItem('gemini_api_key', key);
                setUserKey(key);
            };

            // æ¸…é™¤ Key
            const handleClearKey = () => {
                if (confirm("ç¢ºå®šè¦ç™»å‡ºä¸¦æ¸…é™¤è¨˜æ†¶çš„ API Key å—ï¼Ÿ")) {
                    localStorage.removeItem('gemini_api_key');
                    setUserKey("");
                    window.location.reload();
                }
            };

            const handleSubmit = async () => {
                if (!mood.trim()) return;
                
                if (!userKey) {
                    setErrorMsg("è«‹å…ˆè¨­å®š API Key");
                    return;
                }

                if (audioPlayerRef.current) audioPlayerRef.current.playMusic();
                setStatus('analyzing');
                setErrorMsg('');

                try {
                    const recipeData = await generateCocktailRecipe(userKey, mood);
                    setRecipe(recipeData);
                    setStatus('mixing');
                    const img = await generateCocktailImage(userKey, recipeData.visualPrompt);
                    setImageUrl(img);
                    setStatus('served');
                } catch (err) {
                    console.error(err);
                    setStatus('error');
                    let msg = err.message || "ç³»çµ±ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤";
                    if (msg.includes("429")) {
                        msg = "ç›®å‰è¨ªå®¢çœ¾å¤š (API é™æµ)ï¼Œè«‹ç¨ç­‰ 30 ç§’å¾Œå†è©¦ã€‚";
                    } else if (msg.includes("API_KEY") || msg.includes("403")) {
                         msg = "API Key ç„¡æ•ˆæˆ–éæœŸï¼Œè«‹é‡è¨­æ‚¨çš„ Keyã€‚";
                         // è‹¥ Key ç„¡æ•ˆï¼Œå»ºè­°è‡ªå‹•æ¸…ç©ºè®“ä½¿ç”¨è€…é‡å¡«ï¼Œé€™è£¡å…ˆä¸å¼·åˆ¶ï¼Œè®“ä½¿ç”¨è€…æ‰‹å‹•é‡è¨­
                    }
                    setErrorMsg(msg);
                }
            };

            const handleReset = () => {
                setMood('');
                setStatus('idle');
                setRecipe(null);
                setImageUrl(null);
            };

            return (
                <div className="min-h-screen w-full bg-gradient-to-br from-red-950 via-slate-900 to-black text-white overflow-x-hidden">
                    {/* èƒŒæ™¯ç‰¹æ•ˆ */}
                    <div className="fixed inset-0 pointer-events-none overflow-hidden">
                        <div className="absolute top-0 left-1/4 w-96 h-96 bg-red-600/10 rounded-full blur-3xl"></div>
                        <div className="absolute bottom-0 right-1/4 w-[500px] h-[500px] bg-amber-600/5 rounded-full blur-3xl"></div>
                         <div className="absolute inset-0 opacity-[0.03]" style={{ backgroundImage: `url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='1'/%3E%3C/svg%3E")` }}></div>
                    </div>

                    {!userKey && <KeyInputModal onSave={handleSetKey} />}

                    <AudioPlayer ref={audioPlayerRef} />

                    <main className="relative container mx-auto px-4 py-12 min-h-screen flex flex-col items-center justify-center">
                        {status !== 'served' && (
                            <header className="text-center mb-12 space-y-4 animate-float">
                                <h1 className="text-4xl md:text-6xl font-serif text-transparent bg-clip-text bg-gradient-to-r from-amber-200 via-amber-400 to-amber-200 drop-shadow-[0_0_15px_rgba(251,191,36,0.4)]">æ˜¥ç¯€å¿ƒæƒ…å°é…’é¤¨</h1>
                                <p className="text-red-200/60 font-light tracking-widest text-sm md:text-base">LUNAR NEW YEAR MOOD BISTRO</p>
                            </header>
                        )}

                        {status === 'idle' && (
                            <div className="w-full max-w-2xl animate-fade-in-up">
                                <div className="glass-panel p-8 md:p-12 rounded-2xl shadow-2xl shadow-red-900/20 text-center">
                                    <p className="text-amber-100/80 mb-8 font-serif text-lg leading-relaxed">ä»Šæ™šï¼Œé€™åº§åŸå¸‚ä¾ç„¶å–§å›‚ï¼Œä½†é€™è£¡å¾ˆå®‰éœã€‚<br/>å¯«ä¸‹ä½ çš„å¿ƒæƒ…ï¼Œç„¡è«–æ˜¯å–œæ‚…ã€ç–²æ†Šã€æœŸå¾…é‚„æ˜¯æƒ†æ‚µã€‚</p>
                                    <div className="relative group">
                                        <textarea value={mood} onChange={(e) => setMood(e.target.value)} placeholder="ä»Šæ™šçš„å¿ƒæƒ…æ˜¯..." className="w-full h-40 bg-black/20 border border-amber-900/30 rounded-xl p-4 text-amber-100 placeholder-red-200/20 focus:outline-none focus:border-amber-500/50 transition-all resize-none text-lg font-light" />
                                    </div>
                                    <button onClick={handleSubmit} disabled={!mood.trim()} className="mt-8 px-10 py-4 bg-gradient-to-r from-red-900 to-red-800 border border-red-700/50 text-amber-100 rounded-full font-serif text-lg hover:scale-105 transition-all shadow-[0_0_20px_rgba(153,27,27,0.3)]">è«‹çµ¦æˆ‘ä¸€æ¯ Please</button>
                                </div>
                            </div>
                        )}

                        {(status === 'analyzing' || status === 'mixing') && <LoadingScreen status={status} />}

                        {status === 'error' && (
                            <div className="glass-panel p-8 rounded-xl text-center max-w-md border-red-500/30">
                                <div className="text-4xl mb-4">ğŸ¥€</div>
                                <p className="text-red-200 mb-6 font-mono text-sm">{errorMsg}</p>
                                <button onClick={handleReset} className="px-6 py-2 border border-amber-500/30 text-amber-200 rounded-full hover:bg-amber-900/20">å†è©¦ä¸€æ¬¡</button>
                            </div>
                        )}

                        {status === 'served' && recipe && imageUrl && <ResultCard recipe={recipe} imageUrl={imageUrl} onReset={handleReset} />}
                        
                        <footer className="absolute bottom-4 text-center w-full text-red-900/40 text-xs space-y-2">
                             <p>Â© 2025 Spring Festival Bistro. Powered by Gemini.</p>
                             {/* åƒ…åœ¨é Hardcoded æ¨¡å¼ä¸‹é¡¯ç¤ºæ¸…é™¤æŒ‰éˆ• */}
                             {!HARDCODED_KEY && userKey && (
                                 <button onClick={handleClearKey} className="text-amber-500/50 hover:text-amber-400 underline decoration-dotted">
                                     [ é‡è¨­ API Key ]
                                 </button>
                             )}
                        </footer>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>
